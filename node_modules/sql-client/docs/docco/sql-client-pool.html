<!DOCTYPE html>

<html>
<head>
  <title>sql-client-pool.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="mysql-runner.html">
                mysql-runner.coffee
              </a>
            
              
              <a class="source" href="postgresql-runner.html">
                postgresql-runner.coffee
              </a>
            
              
              <a class="source" href="sqlite3-runner.html">
                sqlite3-runner.coffee
              </a>
            
              
              <a class="source" href="connection-factory.html">
                connection-factory.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="mysql-client.html">
                mysql-client.coffee
              </a>
            
              
              <a class="source" href="postgresql-client.html">
                postgresql-client.coffee
              </a>
            
              
              <a class="source" href="sql-client-pool.html">
                sql-client-pool.coffee
              </a>
            
              
              <a class="source" href="sql-client.html">
                sql-client.coffee
              </a>
            
              
              <a class="source" href="sql-runner.html">
                sql-runner.coffee
              </a>
            
              
              <a class="source" href="sqlite3-client.html">
                sqlite3-client.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>sql-client-pool.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>fs        = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
path      = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
HOMEDIR   = path.join(__dirname,<span class="hljs-string">'..'</span>)
LIB_COV   = path.join(HOMEDIR,<span class="hljs-string">'lib-cov'</span>)
LIB_DIR   = <span class="hljs-keyword">if</span> fs.existsSync(LIB_COV) <span class="hljs-keyword">then</span> LIB_COV <span class="hljs-keyword">else</span> path.join(HOMEDIR,<span class="hljs-string">'lib'</span>)
SQLClient = <span class="hljs-built_in">require</span>( path.join(LIB_DIR,<span class="hljs-string">'sql-client'</span>) ).SQLClient

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SQLClientPool</span></span>

  <span class="hljs-attribute">MESSAGES</span>: {
    <span class="hljs-attribute">POOL_NOT_OPEN</span>:      <span class="hljs-string">"The pool is not open; please call 'open' before invoking this method."</span>
    <span class="hljs-attribute">TOO_MANY_RETURNED</span>:  <span class="hljs-string">"More clients have been returned to the pool than were active. A client may have been returned twice."</span>
    <span class="hljs-attribute">EXHAUSTED</span>:          <span class="hljs-string">"The maxiumum number of clients are already active; cannot obtain a new client."</span>
    <span class="hljs-attribute">MAX_WAIT</span>:           <span class="hljs-string">"The maxiumum number of clients are already active and the maximum wait time has been exceeded; cannot obtain a new client."</span>
    <span class="hljs-attribute">INVALID</span>:            <span class="hljs-string">"Unable to create a valid client."</span>
    <span class="hljs-attribute">INTERNAL_ERROR</span>:     <span class="hljs-string">"Internal error."</span>
    <span class="hljs-attribute">INVALID_ARGUMENT</span>:   <span class="hljs-string">"Invalid argument."</span>
    <span class="hljs-attribute">NULL_RETURNED</span>:      <span class="hljs-string">"A null object was returned."</span>
    <span class="hljs-attribute">CLOSED_WITH_ACTIVE</span>: <span class="hljs-string">"The pool was closed, but some clients remain active (were never returned)."</span>
 }

  <span class="hljs-attribute">DEFAULT_WAIT_INTERVAL</span>: <span class="hljs-number">50</span>

  <span class="hljs-attribute">create</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    client = <span class="hljs-keyword">new</span> SQLClient(<span class="hljs-property">@sql_options</span>...,<span class="hljs-property">@factory</span>)
    client.connect (err)=&gt;
      callback(err,client)

  <span class="hljs-attribute">activate</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    callback(<span class="hljs-literal">null</span>,client)

  <span class="hljs-attribute">validate</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> client? <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> client.pooled_at? <span class="hljs-keyword">or</span> (Date.now()-client.pooled_at) &lt; <span class="hljs-property">@pool_options</span>.max_age)
      callback(<span class="hljs-literal">null</span>,<span class="hljs-literal">true</span>,client)
    <span class="hljs-keyword">else</span>
      callback(<span class="hljs-literal">null</span>,<span class="hljs-literal">false</span>,client)

  <span class="hljs-attribute">passivate</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    callback(<span class="hljs-literal">null</span>,client)

  <span class="hljs-attribute">destroy</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> client?
      client.disconnect(callback)
    <span class="hljs-keyword">else</span>
      callback()

  <span class="hljs-attribute">pool</span>:[]
  <span class="hljs-attribute">pool_options</span>:{}
  <span class="hljs-attribute">open</span>:<span class="hljs-literal">false</span>
  <span class="hljs-attribute">borrowed</span>:<span class="hljs-number">0</span>
  <span class="hljs-attribute">returned</span>:<span class="hljs-number">0</span>
  <span class="hljs-attribute">active</span>:<span class="hljs-number">0</span>

  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@sql_options</span>...,<span class="hljs-property">@factory</span>)</span>-&gt;</span>

  <span class="hljs-attribute">open</span>:<span class="hljs-function"><span class="hljs-params">(opts,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> callback? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> opts <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      callback = opts
      opts = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INVALID_ARGUMENT)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@_config</span> opts, <span class="hljs-function"><span class="hljs-params">(err)</span>=&gt;</span>
        <span class="hljs-property">@open</span> = <span class="hljs-literal">true</span>
        callback?(err)

  <span class="hljs-attribute">close</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> callback? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INVALID_ARGUMENT)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@open</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@pool</span>.length &gt; <span class="hljs-number">0</span>
        <span class="hljs-property">@destroy</span> <span class="hljs-property">@pool</span>.shift(),<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
          <span class="hljs-property">@close</span>(callback)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@active</span> &gt; <span class="hljs-number">0</span>
          callback?(<span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.CLOSED_WITH_ACTIVE))
        <span class="hljs-keyword">else</span>
          callback?()

  <span class="hljs-attribute">borrow</span>:<span class="hljs-function"><span class="hljs-params">(callback,blocked_since)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INVALID_ARGUMENT)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@open</span>
        callback <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.NOT_OPEN)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@active</span> &gt;= <span class="hljs-property">@pool_options</span>.max_active <span class="hljs-keyword">and</span> <span class="hljs-property">@pool_options</span>.when_exhausted <span class="hljs-keyword">is</span> <span class="hljs-string">'fail'</span>
          callback <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.EXHAUSTED)
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@active</span> &gt;= <span class="hljs-property">@pool_options</span>.max_active <span class="hljs-keyword">and</span> <span class="hljs-property">@pool_options</span>.when_exhausted <span class="hljs-keyword">is</span> <span class="hljs-string">'block'</span>
          <span class="hljs-keyword">if</span> blocked_since? <span class="hljs-keyword">and</span> (Date.now() - blocked_since) &gt;= <span class="hljs-property">@pool_options</span>.max_wait
            callback <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.MAX_WAIT)
          <span class="hljs-keyword">else</span>
            blocked_since ?= Date.now()
            setTimeout (<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span><span class="hljs-property">@borrow</span>(callback,blocked_since)), <span class="hljs-property">@pool_options</span>.wait_interval
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@pool</span>.length &gt; <span class="hljs-number">0</span>
          client = <span class="hljs-property">@pool</span>.shift()
          <span class="hljs-property">@_activate_and_validate_or_destroy</span> client, <span class="hljs-function"><span class="hljs-params">(err,valid,client)</span>=&gt;</span>
            <span class="hljs-keyword">if</span> err?
              callback(err)
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid
              <span class="hljs-property">@borrow</span>(callback)
            <span class="hljs-keyword">else</span>
              client.pooled_at = <span class="hljs-literal">null</span>
              client.borrowed_at = Date.now()
              <span class="hljs-property">@active</span>++
              callback(<span class="hljs-literal">null</span>,client)
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@create</span> (err,client)=&gt;
            <span class="hljs-keyword">if</span> err?
              callback(err)
            <span class="hljs-keyword">else</span>
              <span class="hljs-property">@_activate_and_validate_or_destroy</span> client, <span class="hljs-function"><span class="hljs-params">(err,valid,client)</span>=&gt;</span>
                <span class="hljs-keyword">if</span> err?
                  callback(err)
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid
                  callback <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INVALID)
                <span class="hljs-keyword">else</span>
                  client.pooled_at = <span class="hljs-literal">null</span>
                  client.borrowed_at = Date.now()
                  <span class="hljs-property">@active</span>++
                  callback(<span class="hljs-literal">null</span>,client)

  <span class="hljs-attribute">return</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> client? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> callback?) <span class="hljs-keyword">or</span> (callback? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INVALID_ARGUMENT)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client?
      callback(<span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.NULL_RETURNED))
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@active</span> &lt;= <span class="hljs-number">0</span>
      callback(<span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.TOO_MANY_RETURNED))
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@returned</span>++
      <span class="hljs-property">@active</span>--
      <span class="hljs-keyword">if</span> client?
        <span class="hljs-property">@passivate</span> client, <span class="hljs-function"><span class="hljs-params">(err,client)</span>=&gt;</span>
          <span class="hljs-keyword">if</span> err
            callback(err)
          <span class="hljs-keyword">else</span>
            client.pooled_at = Date.now()
            client.borrowed_at = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@pool</span>.length &gt;= <span class="hljs-property">@pool_options</span>.max_idle
              <span class="hljs-property">@destroy</span> client, callback
            <span class="hljs-keyword">else</span>
              <span class="hljs-property">@pool</span>.push client
              callback?()

  <span class="hljs-attribute">_config</span>:<span class="hljs-function"><span class="hljs-params">(opts,callback)</span>=&gt;</span>
    opts ?= {}
    new_opts = <span class="hljs-property">@_clone</span>(<span class="hljs-property">@pool_options</span>)
    keys = Object.keys(opts)
    <span class="hljs-keyword">for</span> prop <span class="hljs-keyword">in</span> [ <span class="hljs-string">'min_idle'</span>,<span class="hljs-string">'max_idle'</span>,<span class="hljs-string">'max_active'</span>, <span class="hljs-string">'when_exhausted'</span>, <span class="hljs-string">'max_wait'</span>, <span class="hljs-string">'wait_interval'</span>, <span class="hljs-string">'max_age'</span> ]
      <span class="hljs-keyword">if</span> prop <span class="hljs-keyword">in</span> keys
        new_opts[prop] = opts[prop]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.max_idle <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">and</span> new_opts.max_idle &lt; <span class="hljs-number">0</span>
      new_opts.max_idle = Number.MAX_VALUE
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.max_idle <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span>
      new_opts.max_idle = <span class="hljs-number">0</span>
    new_opts.min_idle = <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.min_idle <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">or</span> new_opts.min_idle &lt; <span class="hljs-number">0</span>
    new_opts.min_idle = new_opts.max_idle <span class="hljs-keyword">if</span> new_opts.min_idle &gt; new_opts.max_idle
    new_opts.max_active = Number.MAX_VALUE <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.max_active <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">or</span> new_opts.max_active &lt; <span class="hljs-number">0</span>
    new_opts.max_wait = Number.MAX_VALUE <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.max_wait <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">or</span> new_opts.max_wait &lt; <span class="hljs-number">0</span>
    new_opts.wait_interval = <span class="hljs-property">@DEFAULT_WAIT_INTERVAL</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> new_opts.wait_interval <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">or</span> new_opts.wait_interval &lt; <span class="hljs-number">0</span>
    new_opts.when_exhausted = <span class="hljs-string">'grow'</span> <span class="hljs-keyword">unless</span> new_opts.when_exhausted <span class="hljs-keyword">in</span> [ <span class="hljs-string">'grow'</span>,<span class="hljs-string">'block'</span>,<span class="hljs-string">'fail'</span> ]
    new_opts.block_timeout = <span class="hljs-literal">null</span> <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> new_opts.block_timeout <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">and</span> new_opts.block_timeout &gt; <span class="hljs-number">0</span>
    new_opts.max_age = Number.MAX_VALUE <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> new_opts.max_age? <span class="hljs-keyword">or</span> new_opts.max_age &lt; <span class="hljs-number">0</span>
    <span class="hljs-property">@pool_options</span> = new_opts
    <span class="hljs-property">@_reconfig</span>(callback)

  <span class="hljs-attribute">_reconfig</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    <span class="hljs-property">@_evict</span> (err)=&gt;
      <span class="hljs-keyword">if</span> err?
        callback?(err)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@_prepopulate</span> callback

  <span class="hljs-attribute">_evict</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    new_pool = []
    <span class="hljs-keyword">while</span> <span class="hljs-property">@pool</span>.length &gt; <span class="hljs-number">0</span>
      client = <span class="hljs-property">@pool</span>.shift()
      <span class="hljs-keyword">if</span> new_pool.length &lt; <span class="hljs-property">@pool_options</span>.max_idle <span class="hljs-keyword">and</span> <span class="hljs-property">@_is_valid</span>(client)
        new_pool.push client
      <span class="hljs-keyword">else</span>
        client.disconnect()
    <span class="hljs-property">@pool</span> = new_pool
    callback?()

  <span class="hljs-attribute">_prepopulate</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    n = <span class="hljs-property">@pool_options</span>.min_idle - <span class="hljs-property">@pool</span>.length
    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@_borrow_n</span> n, [], <span class="hljs-function"><span class="hljs-params">(err,borrowed)</span>=&gt;</span>
        <span class="hljs-keyword">if</span> err?
          callback(err)
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@_return_n</span> borrowed, callback
    <span class="hljs-keyword">else</span>
      callback()

  <span class="hljs-attribute">_borrow_n</span>:<span class="hljs-function"><span class="hljs-params">(n,borrowed,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> n <span class="hljs-keyword">isnt</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> Array.isArray(borrowed)
      callback(<span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INTERNAL_ERROR))
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> n &gt; borrowed.length
        <span class="hljs-property">@borrow</span> (err,client)=&gt;
          <span class="hljs-keyword">if</span> client?
            borrowed.push client
          <span class="hljs-keyword">if</span> err?
            <span class="hljs-property">@_return_n</span> borrowed, <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
              callback(err)
          <span class="hljs-keyword">else</span>
            <span class="hljs-property">@_borrow_n</span>(n,borrowed,callback)
      <span class="hljs-keyword">else</span>
        callback(<span class="hljs-literal">null</span>,borrowed)

  <span class="hljs-attribute">_return_n</span>:<span class="hljs-function"><span class="hljs-params">(borrowed,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Array.isArray(borrowed)
      callback(<span class="hljs-keyword">new</span> Error(<span class="hljs-property">@MESSAGES</span>.INTERNAL_ERROR))
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> borrowed.length &gt; <span class="hljs-number">0</span>
      client = borrowed.shift()
      <span class="hljs-property">@return</span> client,<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
        <span class="hljs-property">@_return_n</span>(borrowed,callback)
    <span class="hljs-keyword">else</span>
      callback(<span class="hljs-literal">null</span>)

  <span class="hljs-attribute">_activate_and_validate_or_destroy</span>:<span class="hljs-function"><span class="hljs-params">(client,callback)</span>=&gt;</span>
    <span class="hljs-property">@activate</span> client, <span class="hljs-function"><span class="hljs-params">(err,client)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> err?
        <span class="hljs-keyword">if</span> client?
          <span class="hljs-property">@destroy</span> client, <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
            callback(err,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>)
        <span class="hljs-keyword">else</span>
          callback(err,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@validate</span> client, <span class="hljs-function"><span class="hljs-params">(err,valid,client)</span>=&gt;</span>
          <span class="hljs-keyword">if</span> err?
            <span class="hljs-keyword">if</span> client?
              <span class="hljs-property">@destroy</span> client, <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
                callback(err,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>)
            <span class="hljs-keyword">else</span>
              callback(err,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>)
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid
            <span class="hljs-property">@destroy</span> client,<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
              callback(<span class="hljs-literal">null</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>)
          <span class="hljs-keyword">else</span>
            callback(<span class="hljs-literal">null</span>,<span class="hljs-literal">true</span>,client)

  <span class="hljs-attribute">_clone</span>:<span class="hljs-function"><span class="hljs-params">(map)</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> map?
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">else</span>
      cloned = {}
      <span class="hljs-keyword">for</span> n,v <span class="hljs-keyword">of</span> map
        cloned[n] = v
      <span class="hljs-keyword">return</span> cloned

exports.SQLClientPool = SQLClientPool</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
