<!DOCTYPE html>

<html>
<head>
  <title>sql-runner.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="mysql-runner.html">
                mysql-runner.coffee
              </a>
            
              
              <a class="source" href="postgresql-runner.html">
                postgresql-runner.coffee
              </a>
            
              
              <a class="source" href="sqlite3-runner.html">
                sqlite3-runner.coffee
              </a>
            
              
              <a class="source" href="connection-factory.html">
                connection-factory.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="mysql-client.html">
                mysql-client.coffee
              </a>
            
              
              <a class="source" href="postgresql-client.html">
                postgresql-client.coffee
              </a>
            
              
              <a class="source" href="sql-client-pool.html">
                sql-client-pool.coffee
              </a>
            
              
              <a class="source" href="sql-client.html">
                sql-client.coffee
              </a>
            
              
              <a class="source" href="sql-runner.html">
                sql-runner.coffee
              </a>
            
              
              <a class="source" href="sqlite3-client.html">
                sqlite3-client.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>sql-runner.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>fs   = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
Util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inote-util'</span>).Util

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SQLRunner</span></span>

  <span class="hljs-attribute">stop_on_error</span>: <span class="hljs-literal">false</span>

  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"><span class="hljs-params">(client=<span class="hljs-literal">null</span>,options={})</span>-&gt;</span>
    <span class="hljs-keyword">if</span> client? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> options? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> client.execute?
      options = client
      client = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client? <span class="hljs-keyword">and</span> options?.client?
      client = options.client
      options.client = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> options?
      <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> [<span class="hljs-string">'stop_on_error'</span>]
        <span class="hljs-keyword">this</span>[f] = options[f] <span class="hljs-keyword">if</span> options[f]
    <span class="hljs-keyword">if</span> client?
      <span class="hljs-property">@set_client</span>(client)

  <span class="hljs-attribute">set_client</span>:<span class="hljs-function"><span class="hljs-params">(client)</span>=&gt;</span>
    <span class="hljs-property">@client</span> = client

  <span class="hljs-attribute">close</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@client</span>?
      <span class="hljs-property">@client</span>.disconnect(callback)
    <span class="hljs-keyword">else</span>
      callback?()

  <span class="hljs-attribute">execute</span>:<span class="hljs-function"><span class="hljs-params">(sql,callback)</span>-&gt;</span>
    responses  = []
    error = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> Array.isArray(sql)
<span class="hljs-function">      <span class="hljs-title">action</span> = <span class="hljs-params">(stmt,index,list,next)</span>=&gt;</span>
        <span class="hljs-property">@client</span>.execute stmt, <span class="hljs-function"><span class="hljs-params">(err,tail...)</span>=&gt;</span>
          responses.push [err].concat(tail)
          <span class="hljs-keyword">if</span> err?
            error = err
            <span class="hljs-keyword">if</span> stop_on_error
              callback(error,responses)
            <span class="hljs-keyword">else</span>
              next()
          <span class="hljs-keyword">else</span>
            next()
<span class="hljs-function">      <span class="hljs-title">when_done</span> = <span class="hljs-params">()</span>=&gt;</span>
        callback(error,responses)
      Util.for_each_async(sql,action,when_done)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@client</span>.execute(sql,callback)

  <span class="hljs-attribute">execute_file</span>:<span class="hljs-function"><span class="hljs-params">(file,encoding,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> callback? <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> encoding <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      callback = encoding
      encoding = <span class="hljs-literal">null</span>
    options = {}
    options.encoding = encoding <span class="hljs-keyword">if</span> encoding?
    fs.readFile file, options, <span class="hljs-function"><span class="hljs-params">(err,data)</span>=&gt;</span>
      <span class="hljs-keyword">unless</span> Util.handle_error(err,callback)
        execute(data.toString(),callback)

  <span class="hljs-attribute">_BASE_OPTIONS</span>: {
    <span class="hljs-attribute">h</span>: { <span class="hljs-attribute">alias</span>: <span class="hljs-string">'help'</span>,    <span class="hljs-attribute">boolean</span>:<span class="hljs-literal">true</span>, <span class="hljs-attribute">describe</span>: <span class="hljs-string">"Show help"</span> }
    <span class="hljs-attribute">v</span>: { <span class="hljs-attribute">alias</span>: <span class="hljs-string">'verbose'</span>, <span class="hljs-attribute">boolean</span>:<span class="hljs-literal">true</span>, <span class="hljs-attribute">describe</span>: <span class="hljs-string">"Be more chatty."</span> }
    <span class="hljs-attribute">q</span>: { <span class="hljs-attribute">alias</span>: <span class="hljs-string">'quiet'</span>,   <span class="hljs-attribute">boolean</span>:<span class="hljs-literal">true</span>, <span class="hljs-attribute">describe</span>: <span class="hljs-string">"Be less chatty."</span> }
    <span class="hljs-string">'stop-on-error'</span>: { <span class="hljs-attribute">alias</span>: <span class="hljs-string">'stop_on_error'</span>,   <span class="hljs-attribute">boolean</span>:<span class="hljs-literal">true</span>, <span class="hljs-attribute">describe</span>: <span class="hljs-string">"Stop on error"</span> }
  }

  <span class="hljs-attribute">_get_options</span>:<span class="hljs-function"><span class="hljs-params">(additional={})</span>=&gt;</span>
    Util.merge(<span class="hljs-property">@_BASE_OPTIONS</span>,additional)

  <span class="hljs-attribute">_handle_argv</span>:<span class="hljs-function"><span class="hljs-params">(argv)</span>=&gt;</span>
    argv.v = argv.verbose = <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> argv.quiet
    <span class="hljs-keyword">return</span> argv

  <span class="hljs-attribute">_stringify_results</span>:<span class="hljs-function"><span class="hljs-params">(results...)</span>=&gt;</span>
    <span class="hljs-keyword">return</span> JSON.stringify(results,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>)

  <span class="hljs-attribute">main</span>:<span class="hljs-function"><span class="hljs-params">(argv,logfn,errfn,callback)</span>=&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>set default arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> errfn? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> callback?
      callback = errfn
      errfn = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> logfn? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> callback?
      callback = lognf
      logfn = <span class="hljs-literal">null</span>
    argv ?= process.argv
    logfn ?= <span class="hljs-built_in">console</span>.log
    errfn ?= <span class="hljs-built_in">console</span>.error
    callback ?= process.exit</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>swap out process.argv so that optimist reads the function argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    original_argv = process.argv
    process.argv = argv</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>perform the rest of the operation in a try block so we can be
sure to restore process.argv when we’re finished.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>read command line parameters using node-optimist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      optimist = <span class="hljs-built_in">require</span>(<span class="hljs-string">'optimist'</span>)
      argv = optimist.usage(<span class="hljs-string">'Usage: $0 ...'</span>, <span class="hljs-property">@_get_options</span>()).argv
      argv = <span class="hljs-property">@_handle_argv</span>(argv)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>handle help</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> argv.help
        optimist.showHelp(errfn)
        callback()
      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>make sure we’ve got a client to run with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">unless</span> <span class="hljs-property">@client</span>
          errfn(<span class="hljs-string">"SQLClient not configured."</span>) <span class="hljs-keyword">unless</span> argv.quiet
          callback(<span class="hljs-number">3</span>)
        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>read input files or stdin using node-argf</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          ARGF = <span class="hljs-built_in">require</span>(<span class="hljs-string">'argf'</span>)
          argf = <span class="hljs-keyword">new</span> ARGF(argv._)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>after all data has been read, execute the input sql</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          argf.<span class="hljs-literal">on</span> <span class="hljs-string">'finished'</span>, <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
            sql = buffer.join(<span class="hljs-string">"\n"</span>)
            <span class="hljs-keyword">if</span> argv.verbose
              logfn <span class="hljs-string">"Read <span class="hljs-subst">#{sql.length}</span> character(s) in <span class="hljs-subst">#{buffer.length}</span> line(s)."</span>
            <span class="hljs-keyword">if</span> sql.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
              <span class="hljs-keyword">unless</span> argv.quiet
                errfn <span class="hljs-string">"No input found. Cannot continue. (Try --help for help.)"</span>
              callback(<span class="hljs-number">2</span>)
            <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">if</span> argv.verbose
                logfn <span class="hljs-string">"Executing."</span>
            <span class="hljs-property">@execute</span> sql,<span class="hljs-function"><span class="hljs-params">(err,result...)</span>=&gt;</span>
              <span class="hljs-keyword">if</span> err?
                <span class="hljs-keyword">unless</span> argv.quiet
                  errfn <span class="hljs-string">"ERROR"</span> <span class="hljs-keyword">if</span> argv.verbose
                  errfn <span class="hljs-string">"Encountered error:"</span>,err
                  errfn <span class="hljs-string">"while executing SQL:\n"</span>,sql
                callback(<span class="hljs-number">1</span>)
              <span class="hljs-keyword">else</span>
                logfn <span class="hljs-string">"SUCCESS"</span> <span class="hljs-keyword">if</span> argv.verbose
                <span class="hljs-keyword">unless</span> argv.quiet
                  logfn(<span class="hljs-property">@_stringify_results</span>(result...))
                callback()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>create one big buffer containing all input data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> argv.verbose
            <span class="hljs-keyword">if</span> argv._?.length &gt; <span class="hljs-number">0</span>
              logfn <span class="hljs-string">"Reading from <span class="hljs-subst">#{argv._?.length}</span> input files."</span>
            <span class="hljs-keyword">else</span>
              logfn <span class="hljs-string">"Reading from stdin."</span>
          buffer = []
          argf.forEach (line)=&gt;
            buffer.push line
    <span class="hljs-keyword">finally</span>
      process.argv = original_argv

exports.SQLRunner = SQLRunner</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
