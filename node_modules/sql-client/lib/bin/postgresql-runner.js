// Generated by CoffeeScript 1.8.0
(function() {
  var HOMEDIR, LIB_COV, LIB_DIR, PostgreSQLClient, PostgreSQLRunner, SQLRunner, Util, fs, path,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  fs = require('fs');

  path = require('path');

  HOMEDIR = path.join(__dirname, '..', '..');

  LIB_COV = path.join(HOMEDIR, 'lib-cov');

  LIB_DIR = fs.existsSync(LIB_COV) ? LIB_COV : path.join(HOMEDIR, 'lib');

  SQLRunner = require(path.join(LIB_DIR, 'sql-runner')).SQLRunner;

  PostgreSQLClient = require(path.join(LIB_DIR, 'postgresql-client')).PostgreSQLClient;

  Util = require('inote-util').Util;

  PostgreSQLRunner = (function(_super) {
    __extends(PostgreSQLRunner, _super);

    function PostgreSQLRunner(connect_string, options) {
      this._stringify_results = __bind(this._stringify_results, this);
      this._handle_argv = __bind(this._handle_argv, this);
      this._get_options = __bind(this._get_options, this);
      this.set_client = __bind(this.set_client, this);
      var client;
      if ((connect_string != null) && typeof connect_string === 'object' && (options == null)) {
        options = connect_string;
        connect_string = null;
      }
      client = null;
      if (connect_string != null) {
        client = new PostgreSQLClient(connect_string);
      }
      PostgreSQLRunner.__super__.constructor.call(this, client, options);
    }

    PostgreSQLRunner.prototype.set_client = function(client) {
      if (client.execute == null) {
        client = new PostgreSQLClient(client);
      }
      return PostgreSQLRunner.__super__.set_client.call(this, client);
    };

    PostgreSQLRunner.prototype._get_options = function(additional) {
      var pg_opts;
      if (additional == null) {
        additional = {};
      }
      pg_opts = {
        d: {
          alias: 'db',
          describe: "Databse connect string."
        }
      };
      return PostgreSQLRunner.__super__._get_options.call(this, Util.merge(pg_opts, additional));
    };

    PostgreSQLRunner.prototype._handle_argv = function(argv) {
      if (argv.db != null) {
        this.set_client(argv.db);
      }
      return PostgreSQLRunner.__super__._handle_argv.call(this, argv);
    };

    PostgreSQLRunner.prototype._stringify_results = function() {
      var results, _ref;
      results = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      if ((results != null ? (_ref = results[0]) != null ? _ref.rows : void 0 : void 0) != null) {
        return JSON.stringify(results[0].rows, null, 2);
      } else {
        return PostgreSQLRunner.__super__._stringify_results.apply(this, results);
      }
    };

    return PostgreSQLRunner;

  })(SQLRunner);

  exports.PostgreSQLRunner = PostgreSQLRunner;

  if (require.main === module) {
    (new PostgreSQLRunner()).main();
  }

}).call(this);
